# 需求文档：前端日志界面新增请求消息和回复内容字段

## 1. 项目现状与核心目标

### 1.1 项目现状
- **项目名称**：new-api（AI API管理系统）
- **前端技术栈**：React + Vite + Semi Design
- **后端技术栈**：Go + Gin + SQLite
- **当前日志界面位置**：`web/src/pages/Log/index.js`
- **当前日志表格组件**：`web/src/components/table/usage-logs/UsageLogsTable.jsx`
- **当前数据结构**：日志表包含`content`和`other`字段用于存储额外信息

### 1.2 核心目标
在前端使用日志界面的每条日志展开区域添加两个新字段：
1. **请求消息** - 显示客户端请求的完整对话历史
2. **回复内容** - 显示上游AI的完整回复内容

## 2. 范围与边界

### 2.1 功能点简述
- [ ] 在日志展开区域新增"请求消息"字段
- [ ] 在日志展开区域新增"回复内容"字段
- [ ] 为两个字段添加复制功能
- [ ] 为"回复内容"添加额外的"复制原始数据"功能
- [ ] 实现流式和非流式响应的内容处理
- [ ] 实现长文本的滚动显示和自动换行

### 2.2 排除项
- 不修改日志数据库表结构
- 不影响现有的日志记录逻辑
- 不修改其他页面的功能
- 不涉及用户权限控制（沿用现有权限机制）

## 3. 举例覆盖需求和边缘情况

### 3.1 例 1：标准对话请求展示
**场景**：用户通过GPT-4模型进行对话
**展示内容**：
- **请求消息**：
  ```
  [
    {"role": "system", "content": "你是一个有用的助手"},
    {"role": "user", "content": "请解释什么是机器学习"}
  ]
  ```
- **回复内容**：
  ```
  机器学习是人工智能的一个分支，它使计算机能够在没有明确编程的情况下学习和改进...
  ```
- **复制按钮**：右上角显示"📋"图标，点击复制显示内容
- **原始数据按钮**：仅在回复内容区域显示"📄原始"按钮

### 3.2 例 2：流式响应处理
**场景**：Claude模型的流式响应
**数据处理**：
- **原始流式数据**：
  ```
  data: {"type": "content_block_delta", "delta": {"type": "text_delta", "text": "机器"}}
  data: {"type": "content_block_delta", "delta": {"type": "text_delta", "text": "学习"}}
  ...
  ```
- **处理后显示内容**：`机器学习`
- **复制原始数据**：点击"📄原始"按钮复制完整的流式数据

### 3.3 例 3：多模态请求
**场景**：包含图片的请求
**请求消息展示**：
```json
[
  {"role": "user", "content": [
    {"type": "text", "text": "描述这张图片"},
    {"type": "image_url", "image_url": {"url": "data:image/jpeg;base64,..."}}
  ]}
]
```

### 3.4 例 4：错误情况处理
**场景**：上游返回错误
**回复内容展示**：
```
错误：模型暂时不可用
原始错误：{"error": {"type": "internal_server_error", "message": "Model overloaded"}}
```

### 3.5 例 5：长文本处理
**场景**：回复内容超过1000字符
**UI表现**：
- 文本框高度限制：300px
- 超出部分显示滚动条
- 文本自动换行
- 复制功能复制完整内容

## 4. 技术实现要点

### 4.1 数据获取策略
1. **请求消息**：通过`common.GetRequestBody(c)`获取完整请求体
2. **回复内容**：从各渠道适配器的`responseBody`中获取完整响应
3. **数据存储**：利用现有的`other`字段存储JSON格式的请求和回复数据

### 4.2 前端组件修改
- 修改`web/src/hooks/usage-logs/useUsageLogsData.jsx`中的`setLogsFormat`函数
- 在`expandDataLocal`中新增两个字段的数据生成逻辑
- 保持现有的`Descriptions`组件展示方式

### 4.3 UI组件规范
- 使用Semi Design的`TextArea`组件
- 文本框宽度：`width: "100%"`
- 最大高度：`maxHeight: "300px"`
- 自动换行：`autoSize={{ minRows: 2, maxRows: 10 }}`

### 4.4 复制功能实现
- 使用现有的`copyText`工具函数
- 为"复制原始数据"按钮添加独立的处理逻辑
- 复制成功后显示Toast提示

## 5. 文件修改清单

### 5.1 后端修改
1. **`service/quota.go`** - 修改`PostConsumeQuota`等函数，在`other`字段中存储完整请求和响应
2. **`relay/*/adaptor.go`** - 各渠道适配器中添加请求体和响应体的捕获逻辑
3. **`model/log.go`** - 可能需要添加辅助函数来处理新的数据结构

### 5.2 前端修改
1. **`web/src/hooks/usage-logs/useUsageLogsData.jsx`** - 修改`setLogsFormat`函数，添加新字段的数据处理
2. **可能需要修改`web/src/helpers/index.js`** - 添加处理请求和回复内容的工具函数

## 6. 验收标准

### 6.1 功能验收
- [ ] 日志展开区域正确显示"请求消息"和"回复内容"字段
- [ ] 复制按钮功能正常，可以复制显示内容
- [ ] "复制原始数据"按钮可以复制完整的上游响应数据
- [ ] 长文本自动显示滚动条，不影响页面布局
- [ ] 流式和非流式响应都能正确处理和显示

### 6.2 性能验收
- [ ] 新功能不影响日志页面的加载速度
- [ ] 大文本内容的复制操作响应及时
- [ ] 页面内存占用无明显增加

### 6.3 兼容性验收
- [ ] 与现有日志筛选功能兼容
- [ ] 与现有权限控制兼容
- [ ] 支持所有现有的日志类型（消费、错误、管理等）

## 7. 风险评估

### 7.1 技术风险
- **数据量增加**：存储完整请求和响应可能增加数据库存储压力
- **性能影响**：大文本内容可能影响页面渲染性能
- **隐私安全**：完整对话内容可能涉及敏感信息

### 7.2 缓解措施
- 可考虑对存储的数据进行压缩
- 实现懒加载，只在展开时获取详细内容
- 保持现有的权限控制机制

## 8. 后续扩展

### 8.1 可能的增强功能
- 添加搜索功能，支持在请求和回复内容中搜索
- 支持导出功能，将完整的对话记录导出为文件
- 添加统计分析，分析常见问题和用户行为模式

### 8.2 长期规划
- 考虑将详细日志存储到独立的表或文件系统中
- 实现日志数据的生命周期管理
- 支持更多格式的数据展示（如表格、图表等）